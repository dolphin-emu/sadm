# -*- python -*-
# ex: set syntax=python:

from buildbot.worker import Worker
from buildbot.changes.filter import ChangeFilter
from buildbot.changes.pb import PBChangeSource
from buildbot.config import BuilderConfig
from buildbot.plugins import reporters
from buildbot.plugins import util
from buildbot.process import results
from buildbot.process.factory import BuildFactory
from buildbot.process.properties import WithProperties
from buildbot.process.results import SUCCESS
from buildbot.steps.master import MasterShellCommand, SetProperty
from buildbot.steps.source.github import GitHub
from buildbot.steps.shell import ShellCommand, Compile, Test
from buildbot.steps.transfer import FileUpload, StringDownload
from buildbot.steps.trigger import Trigger
from buildbot.steps.worker import MakeDirectory, RemoveDirectory
from buildbot.schedulers.basic import AnyBranchScheduler, Dependent
from buildbot.schedulers.timed import Nightly
from buildbot.schedulers.triggerable import Triggerable
from datetime import timedelta
from twisted.cred import strcred

import hashlib
import json
import os
import os.path

WORKERS_PASSWORDS = json.load(open(os.environ["WORKERS_PASSWORDS_PATH"]))
GH_CLIENT_ID = open(os.environ["GH_CLIENT_ID_PATH"]).read().strip()
GH_CLIENT_SECRET = open(os.environ["GH_CLIENT_SECRET_PATH"]).read().strip()
FIFOCI_API_KEY = open(os.environ["FIFOCI_FRONTEND_API_KEY_PATH"]).read().strip()
ANDROID_KEYSTORE_PATH = os.environ["ANDROID_KEYSTORE_PATH"]
ANDROID_KEYSTORE_PASS_PATH = os.environ["ANDROID_KEYSTORE_PASS_PATH"]
UPDATE_SIGNING_KEY_PATH = os.environ["UPDATE_SIGNING_KEY_PATH"]
CHANGE_HOOK_CREDENTIALS_PATH = os.environ["CHANGE_HOOK_CREDENTIALS_PATH"]

ARTIFACTS_BASE_DIR = os.environ["ARTIFACTS_BASE_DIR"]

def StepWasSuccessful(results, step):
    """Pass to hideStepIf in order to hide the step on success."""
    return results == SUCCESS

class GitNoBranch(GitHub):
    """Monkey patch for stupid patch behavior."""

    def __init__(self, *args, **kwargs):
        kwargs.update({'submodules': True})
        super(GitNoBranch, self).__init__(*args, **kwargs)

    def patch(self, _, patch):
        d = self._dovccmd(["apply", "-3", "-p", str(patch[0])],
                initialStdin=patch[1])
        return d

class TriggerIfBranch(Trigger):
    """Monkey patch to trigger only if we're on a given branch."""

    def __init__(self, *args, **kwargs):
        self.branchList = kwargs.pop('branchList')
        super(TriggerIfBranch, self).__init__(*args, **kwargs)

    def run(self):
        sss = self.build.getAllSourceStamps()
        is_master = False
        for ss in sss:
            if not ss.changes:
                continue
            for ch in ss.changes:
                if ch.properties.getProperty("branchname", None) in self.branchList:
                    is_master = True

        if not is_master:
            return results.SKIPPED
        return Trigger.run(self)

    def getResultSummary(self):
        if self.results == results.SKIPPED:
            return {'step': 'skipped (no branch match)'}
        return super().getResultSummary()


def ReliableFileUpload(masterdest, **kwargs):
    """Performs a file upload from a worker, but only doing one CIFS write."""
    masterdir = util.Transform(os.path.dirname, masterdest)
    tmpdest = util.Transform(
        lambda p: os.path.join('/tmp', os.path.basename(p)), masterdest)

    nasdest = util.Transform(
        lambda p: "u129977@u129977.your-storagebox.de:" + p.removeprefix(f'{ARTIFACTS_BASE_DIR}/'),
        masterdest)

    return [
        MasterShellCommand(
            command=["mkdir", "-p", masterdir],
            hideStepIf=StepWasSuccessful,
        ),
        FileUpload(masterdest=tmpdest, **kwargs),
        MasterShellCommand(
            command=["scp", "-P23", tmpdest, nasdest],
            hideStepIf=StepWasSuccessful,
        ),
        MasterShellCommand(
            command=["rm", tmpdest],
            hideStepIf=StepWasSuccessful,
        ),
    ]


def get_sharded_dl_path(path_renderable):
    def transformer(path):
        components = path.split('/')
        basename = components[-1]
        sha = hashlib.sha256(basename.encode('utf-8')).hexdigest()
        shard_key1 = sha[0:2]
        shard_key2 = sha[2:4]
        return '/'.join(components[:-1] + [shard_key1, shard_key2, basename])
    return util.Transform(transformer, path_renderable)


def prioritize_builders(buildmaster, builders):
    def priority(builder):
        name = builder.name
        if "nightly-" in name:
            return 5
        elif "dbg-" in name:
            return 4
        elif "pr-" in name:
            return 3
        elif "fifoci-" in name:
            return 2
        elif "dev-" in name:
            return 1
        elif "release-" in name or "lint" in name:
            return 0
        else:
            return 6

    builders.sort(key=priority)
    return builders


def make_dolphin_win_build(build_type, arch, mode="normal"):
    f = BuildFactory()

    mode = mode.split(",")
    normal = "normal" in mode
    debug = "debug" in mode
    pr = "pr" in mode
    fifoci_golden = "fifoci_golden" in mode
    release = "release" in mode

    update_platform = {"x64": "win", "ARM64": "win-arm64"}[arch]

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))
    f.addStep(RemoveDirectory(dir="build/Binary", hideStepIf=StepWasSuccessful))

    branch = WithProperties("%s", "branchname")
    env = {"DOLPHIN_BRANCH": branch, "DOLPHIN_DISTRIBUTOR": "dolphin-emu.org"}
    if normal or release:
        env["DOLPHIN_DEFAULT_UPDATE_TRACK"] = "beta"
    
    build_command = [
        "msbuild.exe",
        "/v:m",
        "/p:Platform=%s" % arch,
        "/p:Configuration=%s" % build_type,
    ]

    f.addStep(Compile(command=build_command + ["dolphin-emu.sln"],
                      env=env,
                      workdir="build/Source",
                      description="building",
                      descriptionDone="build",
                      haltOnFailure=True))

    if arch == 'x64':
        f.addStep(Test(command=build_command + ["/p:RunUnitTests=true", "UnitTests.vcxproj"],
                        env=env,
                        workdir="build/Source/UnitTests",
                        description="testing",
                        descriptionDone="test",
                        haltOnFailure=True))

    f.addStep(ShellCommand(command=["xcopy", "Binary\\%s" % arch,
                                    "Dolphin-%s" % arch, "/S", "/I", "/Y"],
                           logEnviron=False,
                           description="copying output",
                           descriptionDone="output copy",
                           hideStepIf=StepWasSuccessful))

    out_filename = WithProperties("Dolphin-%%s-%%s-%s.7z" % arch, "branchname", "shortrev")
    f.addStep(ShellCommand(command=["7z", "a", "-r", out_filename,
                                    "Dolphin-%s" % arch],
                           logEnviron=False,
                           description="compressing",
                           descriptionDone="compression",
                           hideStepIf=StepWasSuccessful))

    if debug:
        fn_arch = "dbg-%s" % arch
    else:
        fn_arch = arch

    if release:
        master_filename = WithProperties("%s/dl/releases/%%s/dolphin-%%s-%s.7z" % (ARTIFACTS_BASE_DIR, fn_arch), "shortrev", "shortrev")
        url = WithProperties("https://dl.dolphin-emu.org/releases/%%s/dolphin-%%s-%s.7z" % fn_arch, "shortrev", "shortrev")
    elif normal:
        master_filename = WithProperties("%s/dl/builds/dolphin-%%s-%%s-%s.7z" % (ARTIFACTS_BASE_DIR, fn_arch), "branchname", "shortrev")
        url = WithProperties("https://dl.dolphin-emu.org/builds/dolphin-%%s-%%s-%s.7z" % fn_arch, "branchname", "shortrev")
    elif pr:
        master_filename = WithProperties("%s/dl/prs/%%s-dolphin-latest-%s.7z" % (ARTIFACTS_BASE_DIR, fn_arch), "branchname")
        url = WithProperties("https://dl.dolphin-emu.org/prs/%%s-dolphin-latest-%s.7z" % fn_arch, "branchname")
    else:
        raise RuntimeError("Unexpected build mode")
    
    if not release:
        master_filename, url = map(get_sharded_dl_path, (master_filename, url))

    f.addSteps(ReliableFileUpload(workersrc=out_filename,
                                    masterdest=master_filename,
                                    url=url, keepstamp=True, mode=0o644))

    f.addStep(SetProperty(property="build_url",
                            value=url,
                            hideStepIf=StepWasSuccessful))

    if fifoci_golden and pr:
        f.addStep(Trigger(schedulerNames=["pr-fifoci-win"],
                            copy_properties=["pr_id", "headrev", "branchname", "shortrev", "build_url"],
                            hideStepIf=StepWasSuccessful))

    if (normal or release) and not debug:
        f.addStep(MasterShellCommand(command=["send_build.py",
                                            "--branch", WithProperties("%s", "branchname"),
                                            "--shortrev", WithProperties("%s", "shortrev"),
                                            "--hash", WithProperties("%s", "revision"),
                                            "--author", WithProperties("%s", "author"),
                                            "--description", WithProperties("%s", "description"),
                                            "--target_system", "Windows %s" % (arch),
                                            "--user_os_matcher", "win",
                                            "--build_url", url],
                                    description="notifying website",
                                    descriptionDone="website notice"))

        f.addStep(MasterShellCommand(command=["make_manifest.py",
                                            "--input", master_filename,
                                            "--version_hash", WithProperties("%s", "revision"),
                                            "--platform", update_platform,
                                            "--output-manifest-store", "/data/nas/update/manifest",
                                            "--output-content-store", "/data/nas/update/content",
                                            "--signing-key", UPDATE_SIGNING_KEY_PATH],
                                    description="writing update manifest",
                                    descriptionDone="update manifest write"))

    f.addStep(ShellCommand(command=["del", "/F", "/S", "/Q", out_filename],
                           logEnviron=False,
                           description="cleaning up files",
                           descriptionDone="cleanup files",
                           hideStepIf=StepWasSuccessful))

    f.addStep(ShellCommand(command=["rmdir", "/S", "/Q", "Dolphin-%s" % arch],
                           logEnviron=False,
                           description="cleaning up dirs",
                           descriptionDone="cleanup dirs",
                           hideStepIf=StepWasSuccessful))

    return f

def make_dolphin_osx_universal_build(mode="normal"):
    f = BuildFactory()

    mode = mode.split(",")
    normal = "normal" in mode
    pr = "pr" in mode
    fifoci_golden = "fifoci_golden" in mode
    release = "release" in mode

    # Qt should be fetched before Dolphin to avoid overwriting necessary properties for FifoCI.
    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/ext-macos-qt.git",
                          progress=True, mode="incremental", workdir="qt", branch="master",
                          alwaysUseLatest=True))

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(ShellCommand(command=["mkdir", "-p", "build"],
                           logEnviron=False,
                           description="mkbuilddir",
                           descriptionDone="mkbuilddir",
                           hideStepIf=StepWasSuccessful))

    f.addStep(ShellCommand(command="security unlock-keychain -p $(cat ~/.keychain-password) buildbot.keychain-db",
                           workdir="build/build",
                           description="unlocking keychain",
                           descriptionDone="unlock keychain",
                           haltOnFailure=True,
                           hideStepIf=StepWasSuccessful))
    
    qt_path = WithProperties("%s/qt/latest/universal", "builddir")

    command = [
       "../BuildMacOSUniversalBinary.py",
       "-G", "Ninja",
       "--arm64_qt5_path", qt_path,
       "--x86_64_qt5_path", qt_path,
       "--run_unit_tests",
       "--codesign", "Developer ID",
       "--distributor", "dolphin-emu.org"
    ]

    f.addStep(ShellCommand(command=command,
                           workdir="build/build",
                           description="configuring",
                           descriptionDone="configure",
                           haltOnFailure=True))

    f.addStep(ShellCommand(command="rm -rf dmg.dir && mkdir dmg.dir",
                           workdir="build/build",
                           description="creating tmp dir",
                           descriptionDone="create tmp dir",
                           haltOnFailure=True,
                           hideStepIf=StepWasSuccessful))

    f.addStep(ShellCommand(command="cp -R universal/Dolphin.app dmg.dir",
                           workdir="build/build",
                           description="creating tmp dir",
                           descriptionDone="create tmp dir",
                           haltOnFailure=True,
                           hideStepIf=StepWasSuccessful))

    f.addStep(ShellCommand(command="ln -s /Applications dmg.dir/Applications",
                           workdir="build/build",
                           description="creating Applications link",
                           descriptionDone="create Applications link",
                           haltOnFailure=True,
                           hideStepIf=StepWasSuccessful))

    if normal or release:
        volume_name = WithProperties("Dolphin %s", "shortrev")
    elif pr:
        volume_name = WithProperties("Dolphin %s", "branchname")
    else:
        volume_name = "Dolphin"

    f.addStep(ShellCommand(command=["hdiutil", "create", "dolphin.dmg",
                                    "-format", "UDBZ",
                                    "-fs", "HFS+", # Needed for 7-Zip support
                                    "-srcfolder", "dmg.dir", "-ov",
                                    "-volname", volume_name],
                           workdir="build/build",
                           logEnviron=False,
                           description="packaging",
                           descriptionDone="package"))

    f.addStep(ShellCommand(command=["codesign", "-s", "Developer ID", "dolphin.dmg"],
                           workdir="build/build",
                           logEnviron=False,
                           description="codesigning dmg",
                           descriptionDone="codesign dmg"))

    if normal or release:
        f.addStep(ShellCommand(command=["xcrun", "notarytool", "submit", "dolphin.dmg",
                                        "--keychain-profile", "NotaryCredentials",
                                        "--keychain", "~/Library/Keychains/buildbot.keychain-db",
                                        "--wait"],
                           workdir="build/build",
                           description="notarizing",
                           descriptionDone="notarize",
                           haltOnFailure=True))

        f.addStep(ShellCommand(command=["xcrun", "stapler", "staple", "dolphin.dmg"],
                           workdir="build/build",
                           description="stapling",
                           descriptionDone="staple",
                           haltOnFailure=True))

    f.addStep(ShellCommand(command="security lock-keychain buildbot.keychain-db",
                        workdir="build/build",
                        description="locking keychain",
                        descriptionDone="lock keychain",
                        haltOnFailure=True,
                        hideStepIf=StepWasSuccessful))
    
    if release:
        master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/releases/%s/dolphin-%s-universal.dmg", "shortrev", "shortrev")
        url = WithProperties("https://dl.dolphin-emu.org/releases/%s/dolphin-%s-universal.dmg", "shortrev", "shortrev")
    elif normal:
        master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/builds/dolphin-%s-%s-universal.dmg", "branchname", "shortrev")
        url = WithProperties("https://dl.dolphin-emu.org/builds/dolphin-%s-%s-universal.dmg", "branchname", "shortrev")
    elif pr:
        master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/prs/%s-dolphin-latest-universal.dmg", "branchname")
        url = WithProperties("https://dl.dolphin-emu.org/prs/%s-dolphin-latest-universal.dmg", "branchname")
    else:
        raise RuntimeError("Unexpected build mode")

    if not release:
        master_filename, url = map(get_sharded_dl_path, (master_filename, url))

    f.addSteps(ReliableFileUpload(workersrc="build/dolphin.dmg",
                                    masterdest=master_filename,
                                    url=url, keepstamp=True, mode=0o644))

    if normal or release:
        f.addStep(MasterShellCommand(command=["send_build.py",
                                            "--branch", WithProperties("%s", "branchname"),
                                            "--shortrev", WithProperties("%s", "shortrev"),
                                            "--hash", WithProperties("%s", "revision"),
                                            "--author", WithProperties("%s", "author"),
                                            "--description", WithProperties("%s", "description"),
                                            "--target_system", "macOS (ARM/Intel Universal)",
                                            "--user_os_matcher", "osx",
                                            "--build_url", url],
                                        description="notifying website",
                                        descriptionDone="website notice"))

        f.addStep(ShellCommand(command="rm -rf 7z.dir && mkdir 7z.dir",
                            workdir="build/build",
                            description="creating 7z tmp dir",
                            descriptionDone="create 7z tmp dir",
                            haltOnFailure=True,
                            hideStepIf=StepWasSuccessful))

        f.addStep(ShellCommand(command="cp -R universal/Dolphin.app 7z.dir",
                            workdir="build/build",
                            description="creating 7z tmp dir",
                            descriptionDone="create 7z tmp dir",
                            haltOnFailure=True,
                            hideStepIf=StepWasSuccessful))

        f.addStep(ShellCommand(command=["7z", "a", "dolphin.7z", "7z.dir/*", "-mm=copy"],
                            workdir="build/build",
                            description="creating 7z",
                            descriptionDone="create 7z",
                            haltOnFailure=True))

        tmp_filename = WithProperties("/tmp/macos-universal-%s.7z", "revision")

        f.addStep(FileUpload(workersrc="build/dolphin.7z",
                                masterdest=tmp_filename,
                                keepstamp=True, mode=0o644))

        f.addStep(MasterShellCommand(command=["make_manifest.py",
                                            "--input", tmp_filename,
                                            "--version_hash", WithProperties("%s", "revision"),
                                            "--platform", "macos-universal",
                                            "--output-manifest-store", "/data/nas/update/manifest",
                                            "--output-content-store", "/data/nas/update/content",
                                            "--signing-key", UPDATE_SIGNING_KEY_PATH],
                                    description="writing update manifest",
                                    descriptionDone="update manifest write"))

        f.addStep(MasterShellCommand(command=["rm", tmp_filename],
                                    description="cleaning up",
                                    descriptionDone="clean up",
                                    hideStepIf=StepWasSuccessful))

    if fifoci_golden and pr:
        f.addStep(Trigger(schedulerNames=["pr-fifoci-osx"],
                            copy_properties=["pr_id", "repo", "headrev", "branchname", "shortrev"],
                            hideStepIf=StepWasSuccessful))

    return f

def make_dolphin_linux_build(mode="normal"):
    f = BuildFactory()

    mode = mode.split(",")

    debug = "debug" in mode
    pr = "pr" in mode
    fifoci_golden = "fifoci_golden" in mode
    generic = "generic" in mode
    appimage = "appimage" in mode

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(ShellCommand(command=["mkdir", "-p", "build"],
                           logEnviron=False,
                           description="mkbuilddir",
                           descriptionDone="mkbuilddir",
                           hideStepIf=StepWasSuccessful))

    cmake_cmd = ["cmake", "..", "-GNinja"]
    if debug:
        cmake_cmd.append("-DFASTLOG=ON")
    if generic:
        cmake_cmd.append("-DENABLE_GENERIC=ON")
    if appimage:
        cmake_cmd.append("-DLINUX_LOCAL_DEV=true -DCMAKE_INSTALL_PREFIX=/usr")
    cmake_cmd.append("-DDISTRIBUTOR=dolphin-emu.org")
    f.addStep(ShellCommand(command=cmake_cmd,
                           workdir="build/build",
                           description="configuring",
                           descriptionDone="configure",
                           haltOnFailure=True))

    f.addStep(Compile(command=["ninja"],
                      workdir="build/build",
                      description="building",
                      descriptionDone="build",
                      haltOnFailure=True))

    f.addStep(Test(command=["ninja", "unittests"],
                   workdir="build/build",
                   description="testing",
                   descriptionDone="test",
                   haltOnFailure=True))

    if appimage:
        f.addStep(ShellCommand(command="../BuildLinuxAppImage.sh",
                            workdir="build/build",
                            description="Creating AppImage",
                            descriptionDone="Create AppImage",
                            haltOnFailure=True,
                            hideStepIf=StepWasSuccessful))
    if fifoci_golden and pr:
        f.addStep(Trigger(schedulerNames=["pr-fifoci-lin"],
                          copy_properties=["pr_id", "repo", "headrev", "branchname", "shortrev"],
                          hideStepIf=StepWasSuccessful))
    return f

def make_android_package(mode="normal"):
    f = BuildFactory()

    mode = mode.split(",")

    pr = "pr" in mode
    normal = "normal" in mode
    release = "release" in mode

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(ShellCommand(command="rm -rf .cxx/ && rm -rf build/",
                              workdir="build/Source/Android/app",
                              description="Workaround for https://issuetracker.google.com/issues/232060576?pli=1%22",
                              descriptionDone="Workaround for https://issuetracker.google.com/issues/232060576?pli=1%22",
                              haltOnFailure=False))

    if normal or release:
        f.addStep(ShellCommand(command="./gradlew :app:generateReleaseBaselineProfile "
                                       "-P android.testoptions.manageddevices.emulator.gpu=swiftshader_indirect",
                              workdir="build/Source/Android",
                              description="Baseline Profile",
                              descriptionDone="Baseline Profile",
                              haltOnFailure=False))

        f.addStep(ShellCommand(command="./gradlew assembleRelease",
                               workdir="build/Source/Android",
                               description="Gradle APK",
                               descriptionDone="Gradle APK",
                               haltOnFailure=True))

        f.addStep(ShellCommand(command="./gradlew bundleRelease",
                               workdir="build/Source/Android",
                               description="Gradle Bundle",
                               descriptionDone="Gradle Bundle",
                               haltOnFailure=True))

        if release:
            source_filename = "Source/Android/app/build/outputs/apk/release/app-release-unsigned.apk"
            master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/releases/%s/dolphin-%s.apk", "shortrev", "shortrev")
            url = WithProperties("https://dl.dolphin-emu.org/releases/%s/dolphin-%s.apk", "shortrev", "shortrev")

            source_filename_play = "Source/Android/app/build/outputs/bundle/release/app-release.aab"
            master_filename_play = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/releases/%s/dolphin-%s.aab", "shortrev", "shortrev")
            url_play = WithProperties("https://dl.dolphin-emu.org/releases/%s/dolphin-%s.aab", "shortrev", "shortrev")
        else:
            source_filename = "Source/Android/app/build/outputs/apk/release/app-release-unsigned.apk"
            master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/builds/dolphin-%s-%s.apk", "branchname", "shortrev")
            url = WithProperties("https://dl.dolphin-emu.org/builds/dolphin-%s-%s.apk", "branchname", "shortrev")

            source_filename_play = "Source/Android/app/build/outputs/bundle/release/app-release.aab"
            master_filename_play = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/builds/dolphin-%s-%s.aab", "branchname", "shortrev")
            url_play = WithProperties("https://dl.dolphin-emu.org/builds/dolphin-%s-%s.aab", "branchname", "shortrev")

    else:
        f.addStep(ShellCommand(command="./gradlew assembleDebug",
                               workdir="build/Source/Android",
                               description="Gradle",
                               descriptionDone="Gradle",
                               haltOnFailure=True))

        source_filename = "Source/Android/app/build/outputs/apk/debug/app-debug.apk"
        master_filename = WithProperties(f"{ARTIFACTS_BASE_DIR}/dl/prs/%s-dolphin-latest.apk", "branchname")
        url = WithProperties("https://dl.dolphin-emu.org/prs/%s-dolphin-latest.apk", "branchname")

    if not release:
        master_filename, url = map(get_sharded_dl_path, (master_filename, url))

    steps = ReliableFileUpload(workersrc=source_filename,
                               masterdest=master_filename,
                               url=url, keepstamp=True, mode=0o644)

    if normal or release:
        # XXX: Very hacky.
        tmpdest = util.Transform(lambda p: os.path.join('/tmp', os.path.basename(p)), master_filename)
        apksigner = MasterShellCommand(command=["apksigner", "sign",
                                                "--ks", ANDROID_KEYSTORE_PATH,
                                                "--ks-key-alias", "mykey",
                                                "--ks-pass", "file:" + ANDROID_KEYSTORE_PASS_PATH,
                                                tmpdest],
                                       description="Signing release APK",
                                       descriptionDone="Signing release APK",
                                       haltOnFailure=True)
        steps.insert(2, apksigner)

        if not release:
            master_filename_play, url_play = map(get_sharded_dl_path, (master_filename_play, url_play))

        playupload = ReliableFileUpload(workersrc=source_filename_play,
                                       masterdest=master_filename_play,
                                       url=url_play, keepstamp=True, mode=0o644)

        tmpdest = util.Transform(lambda p: os.path.join('/tmp', os.path.basename(p)), master_filename_play)
        jarsigner_cmd = util.Transform(lambda p: ("jarsigner " 
                                                  "-keystore %s "
                                                  "-storepass $(cat %s) "
                                                  "%s mykey") % (ANDROID_KEYSTORE_PATH, ANDROID_KEYSTORE_PASS_PATH, p),
                                       tmpdest)
        jarsigner = MasterShellCommand(command=jarsigner_cmd,
                                       description="Signing release AAB",
                                       descriptionDone="Signing release AAB",
                                       haltOnFailure=True)
        playupload.insert(2, jarsigner)
        steps += playupload

    f.addSteps(steps)

    if normal or release:

        f.addStep(MasterShellCommand(command=["send_build.py",
                                            "--branch", WithProperties("%s", "branchname"),
                                            "--shortrev", WithProperties("%s", "shortrev"),
                                            "--hash", WithProperties("%s", "revision"),
                                            "--author", WithProperties("%s", "author"),
                                            "--description", WithProperties("%s", "description"),
                                            "--target_system", "Android",
                                            "--user_os_matcher", "android",
                                            "--build_url", url],
                                     description="notifying website",
                                     descriptionDone="website notice"))

    return f

def make_dolphin_freebsd_build(mode="normal"):
    f = BuildFactory()

    mode = mode.split(",")

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(ShellCommand(command=["mkdir", "-p", "build"],
                           logEnviron=False,
                           description="mkbuilddir",
                           descriptionDone="mkbuilddir",
                           hideStepIf=StepWasSuccessful))

    cmake_cmd = ["cmake", "..", "-GNinja"]
    cmake_cmd.append("-DDISTRIBUTOR=dolphin-emu.org")
    f.addStep(ShellCommand(command=cmake_cmd,
                           workdir="build/build",
                           description="configuring",
                           descriptionDone="configure",
                           haltOnFailure=True))

    f.addStep(Compile(command=["ninja"],
                      workdir="build/build",
                      description="building",
                      descriptionDone="build",
                      haltOnFailure=True))

    f.addStep(Test(command=["ninja", "unittests"],
                   workdir="build/build",
                   description="testing",
                   descriptionDone="test",
                   haltOnFailure=True))

    return f

def make_fifoci_linux(type, mode="normal"):
    # Requirements for a FifoCI linux buildworker:
    #  - Poetry >= 1.3.0 installed in PATH.
    #  - ~/dff existing to cache DFF files
    #  - ~/fifoci pointing to FifoCI Git

    mode = mode.split(",")
    normal = "normal" in mode
    pr = "pr" in mode

    f = BuildFactory()
    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(ShellCommand(command="cd ~/fifoci && git fetch && git checkout master && git reset --hard origin/master || true",
                           logEnviron=False,
                           description="Updating FifoCI",
                           descriptionDone="FifoCI update"))

    f.addStep(ShellCommand(command=["mkdir", "-p", "build"],
                           logEnviron=False,
                           description="mkbuilddir",
                           descriptionDone="mkbuilddir",
                           hideStepIf=StepWasSuccessful))

    f.addStep(ShellCommand(command="cmake -DCMAKE_INSTALL_PREFIX=$(pwd)/prefix -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_QT=OFF -DENABLE_EVDEV=OFF -GNinja ..",
                           workdir="build/build",
                           description="configuring",
                           descriptionDone="configure",
                           haltOnFailure=True))

    f.addStep(Compile(command=["ninja"],
                      workdir="build/build",
                      description="building",
                      descriptionDone="build",
                      haltOnFailure=True))

    f.addStep(Compile(command=["ninja", "install"],
                      workdir="build/build",
                      description="installing",
                      descriptionDone="install",
                      haltOnFailure=True))

    f.addStep(ShellCommand(command="poetry install -C ~/fifoci/fifoci/runner",
                           description="updating deps",
                           descriptionDone="deps update",
                           haltOnFailure=True))

    f.addStep(StringDownload(FIFOCI_API_KEY,
                             workerdest="fifoci-api.key",
                             workdir="build/build",
                             description="uploading API key",
                             descriptionDone="API key upload",
                             haltOnFailure=True,
                             hideStepIf=StepWasSuccessful))

    url_base = "https://fifo.ci"
    args = [
        "--type", type,
        "--dolphin", "$(pwd)/prefix/bin/dolphin-emu-nogui",
        "--rev_base_hash", "$(git rev-parse HEAD)",
        "--output", "result.zip",
        "--import_api_key_file", "fifoci-api.key",
        "--url_base", url_base,
        "--dff_dir", "~/dff",
    ]
    if normal:
        args += [
            "--rev_hash", "$(git rev-parse HEAD)",
            "--rev_name", "%(shortrev)s",
            "--rev_submitted", "true",
        ]
    elif pr:
        args += [
            "--rev_hash", "%(headrev)s",
            "--rev_name", "%(branchname)s-%(shortrev)s",
            "--rev_submitted", "false",
        ]
    command = "poetry run -C ~/fifoci/fifoci/runner fifoci-runner " + " ".join(args)
    f.addStep(ShellCommand(command=WithProperties(command),
                           workdir="build/build",
                           description="gfx testing",
                           descriptionDone="gfx test",
                           haltOnFailure=True))

    return f

def make_fifoci_osx(type, mode="normal"):
    # Requirements for a FifoCI macOS buildworker:
    #  - coreutils package installed with brew
    #  - Poetry >= 1.3.0 installed in PATH.
    #  - ~/dff existing to cache DFF files
    #  - ~/fifoci pointing to FifoCI Git

    mode = mode.split(",")
    normal = "normal" in mode
    pr = "pr" in mode

    f = BuildFactory()
    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))

    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/ext-macos-qt.git",
                          progress=True, mode="incremental", workdir="qt", branch="master",
                          alwaysUseLatest=True))

    f.addStep(ShellCommand(command="cd ~/fifoci && git fetch && git checkout master && git reset --hard origin/master || true",
                           logEnviron=False,
                           description="Updating FifoCI",
                           descriptionDone="FifoCI update"))

    f.addStep(ShellCommand(command=["mkdir", "-p", "build"],
                           logEnviron=False,
                           description="mkbuilddir",
                           descriptionDone="mkbuilddir",
                           hideStepIf=StepWasSuccessful))

    command = [
        "cmake",
        "-G", "Ninja",
        WithProperties("-DCMAKE_PREFIX_PATH=%s/qt/latest/universal", "builddir"),
        "-DCMAKE_BUILD_TYPE=RelWithDebInfo",
        "-DUSE_MGBA=OFF",
        ".."
    ]

    f.addStep(ShellCommand(command=command,
                           workdir="build/build",
                           description="configuring",
                           descriptionDone="configure",
                           haltOnFailure=True))

    f.addStep(Compile(command=["ninja"],
                      workdir="build/build",
                      description="building",
                      descriptionDone="build",
                      haltOnFailure=True))

    f.addStep(ShellCommand(command="poetry install -C ~/fifoci/fifoci/runner",
                           description="updating deps",
                           descriptionDone="deps update",
                           haltOnFailure=True))

    f.addStep(StringDownload(FIFOCI_API_KEY,
                             workerdest="fifoci-api.key",
                             workdir="build/build",
                             description="uploading API key",
                             descriptionDone="API key upload",
                             haltOnFailure=True,
                             hideStepIf=StepWasSuccessful))

    url_base = "https://fifo.ci"
    args = [
        "--type", type,
        "--dolphin", "Binaries/",
        "--rev_base_hash", "$(git rev-parse HEAD)",
        "--output", "result.zip",
        "--import_api_key_file", "fifoci-api.key",
        "--url_base", url_base,
        "--dff_dir", "$HOME/dff",
    ]
    if normal:
        args += [
            "--rev_hash", "$(git rev-parse HEAD)",
            "--rev_name", "%(shortrev)s",
            "--rev_submitted", "true",
        ]
    elif pr:
        args += [
            "--rev_hash", "%(headrev)s",
            "--rev_name", "%(branchname)s-%(shortrev)s",
            "--rev_submitted", "false",
        ]
    command = "poetry run -C ~/fifoci/fifoci/runner fifoci-runner " + " ".join(args)
    f.addStep(ShellCommand(command=WithProperties(command),
                           workdir="build/build",
                           description="gfx testing",
                           descriptionDone="gfx test",
                           haltOnFailure=True))

    return f

def make_lint():
    f = BuildFactory()
    f.addStep(GitNoBranch(repourl="https://github.com/dolphin-emu/dolphin.git",
                          progress=True, mode="incremental"))
    # Make sure the baserev exists locally. GitHub's "baserev" property is
    # the current base branch head, which isn't guaranteed to exist in the PR
    # branch (e.g. if it hasn't been rebased).
    f.addStep(ShellCommand(command=['git', 'fetch', 'origin']))
    f.addStep(ShellCommand(command=['Tools/lint.sh', WithProperties("%s...", "baserev")],
                           logEnviron=False,
                           description="lint",
                           descriptionDone="lint",
                           haltOnFailure=False))
    return f


BuildmasterConfig = {
    "title": "Dolphin Emulator",
    "titleURL": "https://github.com/dolphin-emu/dolphin.git",
    "buildbotURL": "https://dolphin.ci/",

    # Set low horizons to avoid IO issues.
    "changeHorizon": 100,
    "configurators": [util.JanitorConfigurator(
        build_data_horizon=timedelta(weeks=4),
        logHorizon=timedelta(weeks=4),
        hour=5,
        dayOfWeek=6,
    )],

    # More caching, less IO.
    "caches": {
        "Changes": 5000,
        "Builds": 500,
        "BuildRequests": 200,
        "SourceStamps": 200,
    },

    "prioritizeBuilders": prioritize_builders,

    "workers": [
        Worker("windows", WORKERS_PASSWORDS["windows"], max_builds=1),
        Worker("osx-m1", WORKERS_PASSWORDS["osx-m1"], max_builds=1),
        Worker("debian", WORKERS_PASSWORDS["debian"], max_builds=1),
        Worker("freebsd", WORKERS_PASSWORDS["freebsd"], max_builds=1),
        Worker("steamrt", WORKERS_PASSWORDS["steamrt"], max_builds=1),
        Worker("ubuntu-lts", WORKERS_PASSWORDS["ubuntu-lts"], max_builds=1),
        Worker("android", WORKERS_PASSWORDS["android"], max_builds=1),
        Worker("altair-fifoci", WORKERS_PASSWORDS["altair-fifoci"], max_builds=1),
    ],

    "protocols": {
        "pb": {"port": int(os.environ["PB_PORT"])},
    },

    "schedulers": [
        AnyBranchScheduler(
            name="release",
            builderNames=[
                "release-win-x64",
                "release-win-arm64",
                "release-osx-universal",
                "release-android",
            ],
            change_filter=util.ChangeFilter(filter_fn=lambda c: c.properties.getProperty('branchname') == "releases"),
        ),

        AnyBranchScheduler(
            name="dev",
            builderNames=[
                "dev-win-x64",
                "dev-win-arm64",
                "dev-osx-universal",
                "dev-android",

                "fifoci-ogl-lin-mesa",
                "fifoci-sw-lin-mesa",
                "fifoci-mvk-osx-m1",
                "fifoci-mtl-osx-m1",
            ],
            change_filter=util.ChangeFilter(filter_fn=lambda c: not c.properties.getProperty('branchname').startswith("pr-") and c.properties.getProperty('branchname') != "releases"),
        ),

        AnyBranchScheduler(
            name="pr",
            builderNames=[
                 "pr-win-x64",
                 "pr-win-dbg-x64",
                 "pr-win-arm64",
                 "pr-osx-universal",
                 "pr-deb-x64",
                 "pr-deb-dbg-x64",
                 "pr-ubu-x64",
                 "pr-android",
                 "pr-freebsd-x64",
                 "lint",
            ],
            change_filter=util.ChangeFilter(filter_fn=lambda c: c.properties.getProperty('branchname').startswith("pr-")),
        ),

        Triggerable(name="pr-fifoci-lin", builderNames=[
                        "pr-fifoci-ogl-lin-mesa",
                        "pr-fifoci-sw-lin-mesa",
                    ]),
        Triggerable(name="pr-fifoci-osx", builderNames=[
                        "pr-fifoci-mvk-osx-m1",
                        "pr-fifoci-mtl-osx-m1",
                    ]),
        Triggerable(name="pr-fifoci-win", builderNames=[
                    ]),

        Nightly(name="nightly", hour=0, builderNames=[
                    "nightly-generic",
                ]),
    ],

    "builders": [
        BuilderConfig(name="release-win-x64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "x64", "release")),
        BuilderConfig(name="release-win-arm64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "ARM64", "release")),
        BuilderConfig(name="release-osx-universal", workernames=["osx-m1"],
                      factory=make_dolphin_osx_universal_build("release")),
        BuilderConfig(name="release-android", workernames=["android"],
                      factory=make_android_package("release")),

        BuilderConfig(name="dev-win-x64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "x64", "normal,fifoci_golden")),
        BuilderConfig(name="dev-win-arm64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "ARM64", "normal")),
        BuilderConfig(name="dev-osx-universal", workernames=["osx-m1"],
                      factory=make_dolphin_osx_universal_build("normal,fifoci_golden")),
        BuilderConfig(name="dev-android", workernames=["android"],
                      factory=make_android_package("normal")),

        BuilderConfig(name="pr-win-x64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "x64", "pr,fifoci_golden")),
        BuilderConfig(name="pr-win-dbg-x64", workernames=["windows"],
                      factory=make_dolphin_win_build("Debug", "x64", "pr,debug")),
        BuilderConfig(name="pr-win-arm64", workernames=["windows"],
                      factory=make_dolphin_win_build("Release", "ARM64", "pr")),
        BuilderConfig(name="pr-osx-universal", workernames=["osx-m1"],
                      factory=make_dolphin_osx_universal_build("pr,fifoci_golden")),
        BuilderConfig(name="pr-deb-x64", workernames=["debian"],
                      factory=make_dolphin_linux_build("pr")),
        BuilderConfig(name="pr-deb-dbg-x64", workernames=["debian"],
                      factory=make_dolphin_linux_build("pr,debug")),
        BuilderConfig(name="pr-ubu-x64", workernames=["ubuntu-lts"],
                      factory=make_dolphin_linux_build("pr,fifoci_golden")),
        BuilderConfig(name="pr-android", workernames=["android"],
                      factory=make_android_package("pr")),
        BuilderConfig(name="pr-freebsd-x64", workernames=["freebsd"],
                      factory=make_dolphin_freebsd_build("pr")),

        BuilderConfig(name="fifoci-ogl-lin-mesa", workernames=["altair-fifoci"],
                      factory=make_fifoci_linux("ogl-lin-mesa")),
        BuilderConfig(name="fifoci-sw-lin-mesa", workernames=["altair-fifoci"],
                      factory=make_fifoci_linux("sw-lin-mesa")),
        BuilderConfig(name="fifoci-mvk-osx-m1", workernames=["osx-m1"],
                      factory=make_fifoci_osx("mvk-osx-m1")),
        BuilderConfig(name="fifoci-mtl-osx-m1", workernames=["osx-m1"],
                      factory=make_fifoci_osx("mtl-osx-m1")),

        BuilderConfig(name="pr-fifoci-ogl-lin-mesa", workernames=["altair-fifoci"],
                      factory=make_fifoci_linux("ogl-lin-mesa", "pr")),
        BuilderConfig(name="pr-fifoci-sw-lin-mesa", workernames=["altair-fifoci"],
                      factory=make_fifoci_linux("sw-lin-mesa", "pr")),
        BuilderConfig(name="pr-fifoci-mvk-osx-m1", workernames=["osx-m1"],
                      factory=make_fifoci_osx("mvk-osx-m1", "pr")),
        BuilderConfig(name="pr-fifoci-mtl-osx-m1", workernames=["osx-m1"],
                      factory=make_fifoci_osx("mtl-osx-m1", "pr")),

        BuilderConfig(name="lint", workernames=["ubuntu-lts"],
                      factory=make_lint()),

        BuilderConfig(name="nightly-generic", workernames=["ubuntu-lts"],
                      factory=make_dolphin_linux_build("nightly,generic")),
    ],

    "www": {
        "port": int(os.environ["HTTP_PORT"]),
        "auth": util.GitHubAuth(
            clientId=GH_CLIENT_ID,
            clientSecret=GH_CLIENT_SECRET,
            apiVersion=4,
            getTeamsMembership=True,
        ),
        "authz": util.Authz(
            allowRules=[
                util.AnyControlEndpointMatcher(role="trusted-developers"),
            ],
            roleMatchers=[
                util.RolesFromGroups(groupPrefix="dolphin-emu/"),
            ],
        ),
        "plugins": {
            "waterfall_view": {"num_builds": 50},
            "console_view": {},
            "grid_view": {},
        },
        "change_hook_dialects": {
            "base": True,
        },
        "change_hook_auth": [strcred.makeChecker("file:" + CHANGE_HOOK_CREDENTIALS_PATH)]
    },

    "services": [
        reporters.HttpStatusPush(serverUrl="https://central.dolphin-emu.org/buildbot"),
        reporters.Prometheus(port=int(os.environ["PROM_PORT"])),
    ],

    "db": {
        "db_url": "postgresql://buildbot@/buildbot",
    },

    "collapseRequests": False,
}
